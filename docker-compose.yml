version: '3.8'

services:

  # --- CONTAINER 1: THE LISTENER ---
  # Python script that subscribes to the Bambu MQTT feed and writes raw print
  # job records to the shared SQLite database (the Bronze/Raw layer).
  logger:
    build: ./ingestion
    container_name: bambu_logger
    restart: unless-stopped
    volumes:
      - shared_data:/data
      # Map config so credentials can be edited without rebuilding the image.
      - ./ingestion/config.json:/app/config.json

  # --- CONTAINER 2: THE ORCHESTRATOR ---
  # Dagster webserver + daemon.  The sensor polls the raw DB and triggers dbt
  # whenever a new finished print job appears.  UI is at localhost:3000.
  dagster:
    build: ./orchestration
    container_name: bambu_dagster
    restart: unless-stopped
    environment:
      DAGSTER_HOME: /opt/dagster/dagster_home
    volumes:
      - shared_data:/data
      # Mount the dbt project so Dagster can shell out to dbt run.
      - ./transformation:/opt/dbt_project
    ports:
      - "3000:3000"

  # --- CONTAINER 3: DBT DOCS ---
  # Serves the dbt documentation UI on port 8080.
  # On startup it attempts a full doc generation (needs a live DB); if the DB
  # is not yet available it falls back to compile-only so the UI still loads.
  dbt-docs:
    build: ./transformation
    container_name: bambu_dbt_docs
    restart: unless-stopped
    volumes:
      - shared_data:/data
      - ./transformation:/opt/dbt_project
    ports:
      - "8080:8080"

volumes:
  shared_data:
